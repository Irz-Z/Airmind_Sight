<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üáπüá≠ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            thai: {
              red: '#ED1C24',
              blue: '#2E2A7F',
              white: '#FFFFFF'
            }
          },
          fontFamily: {
            'thai': ['Kanit', 'Noto Sans Thai', 'sans-serif']
          }
        }
      }
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Kanit', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .pulse-animation { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    /* Air Quality Colors */
    .air-quality-good { background: linear-gradient(135deg, #4ade80, #22c55e); } /* Green */
    .air-quality-moderate { background: linear-gradient(135deg, #fbbf24, #f59e0b); } /* Yellow */
    .air-quality-unhealthy-sensitive { background: linear-gradient(135deg, #f87171, #ef4444); } /* Orange/Red for sensitive groups */
    .air-quality-unhealthy { background: linear-gradient(135deg, #a78bfa, #8b5cf6); } /* Purple */
    .air-quality-very-unhealthy { background: linear-gradient(135deg, #ef4444, #dc2626); } /* Dark Red */
    .air-quality-hazardous { background: linear-gradient(135deg, #881337, #4c0519); } /* Darker Red/Brown */

    .loading-spinner { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

  <!-- Header -->
  <header class="gradient-bg text-white py-8 mb-8">
    <div class="max-w-6xl mx-auto px-4">
      <h1 class="text-4xl font-bold text-center mb-2">üáπüá≠ ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢</h1>
      <p class="text-center text-white/90">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</p>
    </div>
  </header>

  <!-- Main Content -->
  <div class="max-w-6xl mx-auto px-4 pb-8">
    
    <!-- Search Form -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <form method="POST" class="flex flex-col gap-4">
        <div class="flex flex-col sm:flex-row items-end gap-4">
          <div class="flex-1 w-full">
            <label for="province" class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
            <input 
              name="province" 
              id="province"
              value="{{ province }}" 
              placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà, ‡πÇ‡∏Ñ‡∏£‡∏≤‡∏ä, ‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï, ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£..." 
              class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            />
          </div>
          <div class="w-full sm:w-auto">
            <label for="sort_by_dust" class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡∏ù‡∏∏‡πà‡∏ô</label>
            <select 
              name="sort_by_dust" 
              id="sort_by_dust"
              class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="aqius" {% if sort_by_dust == 'aqius' %}selected{% endif %}>AQI (US)</option>
              <option value="pm25" {% if sort_by_dust == 'pm25' %}selected{% endif %}>PM2.5</option>
              <option value="pm10" {% if sort_by_dust == 'pm10' %}selected{% endif %}>PM10</option>
            </select>
          </div>
          <div class="w-full sm:w-auto">
            <button 
              type="submit" 
              class="w-full sm:w-auto bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors duration-200 font-medium shadow-md hover:shadow-lg"
            >
              üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </button>
          </div>
        </div>
        
        <!-- Time Series Options -->
        <div class="border-t pt-4">
          <div class="flex flex-col sm:flex-row items-end gap-4">
            <div class="flex items-center">
              <input 
                type="checkbox" 
                name="enable_time_series" 
                id="enable_time_series"
                value="true"
                {% if enable_time_series %}checked{% endif %}
                class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                onchange="toggleTimeSeriesOptions()"
              />
              <label for="enable_time_series" class="text-sm font-medium text-gray-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Time Series</label>
            </div>
            
            <div id="timeSeriesOptions" class="flex flex-col sm:flex-row gap-4 {% if not enable_time_series %}hidden{% endif %}">
              <div>
                <label for="time_mode" class="block text-sm font-medium text-gray-700 mb-1">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤</label>
                <select 
                  name="time_mode" 
                  id="time_mode"
                  class="px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                  onchange="toggleTimeMode()"
                >
                  <option value="historical" {% if time_mode == 'historical' or not time_mode %}selected{% endif %}>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</option>
                  <option value="forecast" {% if time_mode == 'forecast' %}selected{% endif %}>‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</option>
                  <option value="custom" {% if time_mode == 'custom' %}selected{% endif %}>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                </select>
              </div>
              
              <div id="historicalOptions" class="flex gap-4 {% if time_mode == 'forecast' %}hidden{% endif %}">
                <div>
                  <label for="start_date" class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                  <input 
                    type="date" 
                    name="start_date" 
                    id="start_date"
                    value="{{ start_date or '' }}"
                    class="px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                  />
                </div>
                
                <div>
                  <label for="end_date" class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                  <input 
                    type="date" 
                    name="end_date" 
                    id="end_date"
                    value="{{ end_date or '' }}"
                    class="px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                  />
                </div>
              </div>
              
              <div id="forecastOptions" class="{% if time_mode != 'forecast' %}hidden{% endif %}">
                <label for="forecast_days" class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå</label>
                <select 
                  name="forecast_days" 
                  id="forecast_days"
                  class="px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                >
                  <option value="3" {% if forecast_days == '3' %}selected{% endif %}>3 ‡∏ß‡∏±‡∏ô</option>
                  <option value="5" {% if forecast_days == '5' %}selected{% endif %}>5 ‡∏ß‡∏±‡∏ô</option>
                  <option value="7" {% if forecast_days == '7' %}selected{% endif %}>7 ‡∏ß‡∏±‡∏ô</option>
                </select>
              </div>
              
              <div>
                <label for="time_interval" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                <select 
                  name="time_interval" 
                  id="time_interval"
                  class="px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                >
                  <option value="daily" {% if time_interval == 'daily' %}selected{% endif %}>‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                  <option value="weekly" {% if time_interval == 'weekly' %}selected{% endif %}>‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                  <option value="monthly" {% if time_interval == 'monthly' %}selected{% endif %}>‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Error Message -->
    {% if error_message %}
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-8 rounded-lg">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="font-medium">{{ error_message }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Results -->
    {% if province and results %}
    <div class="mb-8">
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800">üìç ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: {{ province }}</h2>
        
        {% if results.total_count %}
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
          <p class="text-green-800 font-medium">‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î {{ results.total_count }} ‡πÅ‡∏´‡πà‡∏á</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Tourism Places with Air Quality -->
    {% if results.tourism %}
    <div class="mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
        üèõÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß (‡∏£‡∏ß‡∏°‡∏ß‡∏±‡∏î/‡∏®‡∏≤‡∏™‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô)
        <span class="ml-2 bg-blue-100 text-blue-800 text-sm px-2 py-1 rounded-full">{{ results.tourism|length }}</span>
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {# --- Custom ranking logic for medals --- #}
        {% set last_value = None %}
        {% set rank = 0 %}
        {% set shown = 0 %}
        {% for place in results.tourism %}
        <div class="bg-white rounded-lg shadow-md card-hover overflow-hidden">
          <div class="p-6">
            <h4 class="text-lg font-semibold text-gray-800 mb-2">{{ place.name or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</h4>
            
            <!-- Air Quality Badge -->
            {% if place.air_quality %}
            <div class="mb-3 flex flex-wrap gap-2">
              {% set aqi = place.air_quality.aqi %}
              {% set pm25 = place.air_quality.pm25 %}
              {% set pm10 = place.air_quality.pm10 %}
              
              {% set aqi_level_class = 'air-quality-good' %}
              {% set aqi_level_icon = 'üü¢' %}

              {% if aqi > 200 %}
                {% set aqi_level_class = 'air-quality-hazardous' %}
                {% set aqi_level_icon = '‚ö´' %}
              {% elif aqi > 150 %}
                {% set aqi_level_class = 'air-quality-unhealthy' %}
                {% set aqi_level_icon = 'üî¥' %}
              {% elif aqi > 100 %}
                {% set aqi_level_class = 'air-quality-unhealthy-sensitive' %}
                {% set aqi_level_icon = 'üü†' %}
              {% elif aqi > 50 %}
                {% set aqi_level_class = 'air-quality-moderate' %}
                {% set aqi_level_icon = 'üü°' %}
              {% endif %}

              {# --- Custom medal logic --- #}
              {% set value = aqi %}
              {% if sort_by_dust == 'pm25' %}
                {% set value = pm25 %}
              {% elif sort_by_dust == 'pm10' %}
                {% set value = pm10 %}
              {% endif %}
              {% if value != last_value and value is not none %}
                {% set rank = rank + 1 %}
                {% set last_value = value %}
              {% endif %}
              {% set rank_icon = '' %}
              {% if rank == 1 %}
                {% set rank_icon = 'ü•á' %}
              {% elif rank == 2 %}
                {% set rank_icon = 'ü•à' %}
              {% elif rank == 3 %}
                {% set rank_icon = 'ü•â' %}
              {% endif %}

              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium {{ aqi_level_class }}">
                {% if sort_by_dust == 'aqius' %}
                  {{ aqi_level_icon }} AQI: {{ aqi or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}
                {% elif sort_by_dust == 'pm25' %}
                  {{ aqi_level_icon }} PM2.5: {{ pm25 or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}
                {% elif sort_by_dust == 'pm10' %}
                  {{ aqi_level_icon }} PM10: {{ pm10 or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}
                {% endif %}
                {% if sort_by_dust == 'aqius' and rank <= 3 and rank_icon %}<span class="ml-1">{{ rank_icon }}</span>{% endif %}
              </span>
              {% if pm25 %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                PM2.5: {{ pm25 or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}
                {% if sort_by_dust == 'pm25' and rank <= 3 and rank_icon %}<span class="ml-1">{{ rank_icon }}</span>{% endif %}
              </span>
              {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                PM2.5: ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏
              </span>
              {% endif %}
              {% if pm10 %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                PM10: {{ pm10 or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}
                {% if sort_by_dust == 'pm10' and rank <= 3 and rank_icon %}<span class="ml-1">{{ rank_icon }}</span>{% endif %}
              </span>
              {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                PM10: ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏
              </span>
              {% endif %}
            </div>
            {% endif %}
            
            <div class="space-y-2 text-sm text-gray-600">
              <p class="flex items-start">
                <span class="font-medium text-gray-800 mr-2">üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</span>
                <span>{{ place.full_address or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
              </p>
              
              <p class="flex items-center">
                <span class="font-medium text-gray-800 mr-2">üó∫Ô∏è ‡∏û‡∏¥‡∏Å‡∏±‡∏î:</span>
                <span>{{ "%.4f"|format(place.lat) }}, {{ "%.4f"|format(place.lon) }}</span>
              </p>
              
              {% if place.type %}
              <p class="flex items-center">
                <span class="font-medium text-gray-800 mr-2">üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span>
                <span>{{ place.type or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</span>
              </p>
              {% else %}
              <p class="flex items-center">
                <span class="font-medium text-gray-800 mr-2">üè∑Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span>
                <span>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</span>
              </p>
              {% endif %}
            </div>
            
            <div class="mt-4 flex gap-2">
              <a 
                href="https://maps.google.com/?q={{ place.lat }},{{ place.lon }}" 
                target="_blank" 
                class="inline-flex items-center px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors"
              >
                üó∫Ô∏è ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
              </a>
              
              {% if place.air_quality %}
              {% set air_city = place.air_quality.city or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' %}
              {% set air_aqi = place.air_quality.aqi or 0 %}
              {% set air_desc = place.air_quality.description or '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' %}
              {% set air_pm25 = place.air_quality.pm25 or 0 %}
              {% set air_pm10 = place.air_quality.pm10 or 0 %}
              <button 
                class="inline-flex items-center px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors air-quality-btn"
                data-city="{{ air_city }}"
                data-aqi="{{ air_aqi }}"
                data-description="{{ air_desc }}"
                data-pm25="{{ air_pm25 }}"
                data-pm10="{{ air_pm10 }}"
              >
                üå¨Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
              </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Time Series Analysis Results -->
    {% if results.time_series and results.time_series.enabled %}
    <div class="mb-8">
      {% if results.time_series.error %}
      <div class="bg-red-50 border border-red-200 rounded-lg p-6">
        <h3 class="text-xl font-bold text-red-800 mb-2">‚ùå Time Series Analysis Error</h3>
        <p class="text-red-700">{{ results.time_series.error }}</p>
      </div>
      {% elif results.time_series.analysis %}
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          üìä ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Time Series
          {% if results.time_series.mode == 'forecast' %}
          <span class="ml-2 bg-purple-100 text-purple-800 text-sm px-2 py-1 rounded-full">
            üîÆ ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå {{ results.time_series.forecast_days }} ‡∏ß‡∏±‡∏ô
          </span>
          {% else %}
          <span class="ml-2 bg-purple-100 text-purple-800 text-sm px-2 py-1 rounded-full">
            {{ results.time_series.start_date }} ‡∏ñ‡∏∂‡∏á {{ results.time_series.end_date }}
          </span>
          {% endif %}
        </h3>
        
        {% set analysis = results.time_series.analysis %}
        {% if analysis.rankings %}
        {% if results.time_series.mode == 'forecast' %}
        <div class="mb-4 bg-amber-50 border border-amber-200 rounded-lg p-3">
          <div class="flex items-center">
            <div class="text-amber-600 mr-2">üîÆ</div>
            <p class="text-amber-800 text-sm font-medium">
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏® - ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            </p>
          </div>
        </div>
        {% elif results.time_series.mode == 'historical' %}
        <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center">
            <div class="text-blue-600 mr-2">üìä</div>
            <p class="text-blue-800 text-sm font-medium">
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á - ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ 
              {% if results.time_series.real_data_count %}
              (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á: {{ results.time_series.real_data_count }} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
              {% endif %}
            </p>
          </div>
        </div>
        {% else %}
        <div class="mb-4 bg-green-50 border border-green-200 rounded-lg p-3">
          <div class="flex items-center">
            <div class="text-green-600 mr-2">‚úÖ</div>
            <p class="text-green-800 text-sm font-medium">
              ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏™‡∏° - ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            </p>
          </div>
        </div>
        {% endif %}
        
        <div class="mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
              <div class="text-green-600 text-2xl mb-1">üèÜ</div>
              <p class="text-sm text-green-600 font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
              <p class="text-green-800 font-bold">{{ analysis.best_place.name if analysis.best_place else '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</p>
              {% if analysis.best_place %}
              <p class="text-green-700 text-sm">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: {{ analysis.best_place.average }}</p>
              {% endif %}
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
              <div class="text-blue-600 text-2xl mb-1">üìà</div>
              <p class="text-sm text-blue-600 font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</p>
              <p class="text-blue-800 font-bold">{{ analysis.total_places }}</p>
              {% if results.time_series.mode == 'forecast' %}
              <p class="text-blue-700 text-sm">‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå: {{ results.time_series.forecast_days }} ‡∏ß‡∏±‡∏ô</p>
              {% else %}
              <p class="text-blue-700 text-sm">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤: {{ results.time_series.interval }}</p>
              {% endif %}
            </div>
            
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
              <div class="text-red-600 text-2xl mb-1">‚ö†Ô∏è</div>
              <p class="text-sm text-red-600 font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
              <p class="text-red-800 font-bold">{{ analysis.worst_place.name if analysis.worst_place else '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}</p>
              {% if analysis.worst_place %}
              <p class="text-red-700 text-sm">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: {{ analysis.worst_place.average }}</p>
              {% endif %}
            </div>
          </div>
          
          <!-- Data Quality Statistics -->
          {% if results.time_series.data_statistics %}
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div class="text-center">
                <div class="text-blue-600 font-bold">{{ results.time_series.data_statistics.total_records }}</div>
                <div class="text-gray-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
              </div>
              <div class="text-center">
                <div class="text-green-600 font-bold">{{ results.time_series.data_statistics.real_data_count }}</div>
                <div class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á</div>
              </div>
              <div class="text-center">
                <div class="text-amber-600 font-bold">{{ results.time_series.data_statistics.cached_data_count }}</div>
                <div class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Cache</div>
              </div>
              <div class="text-center">
                <div class="text-purple-600 font-bold">{{ results.time_series.data_statistics.simulated_data_count }}</div>
                <div class="text-gray-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á</div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {% for place in analysis.rankings %}
          <div class="bg-gray-50 rounded-lg p-4 border">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-semibold text-gray-800">
                {{ place.medal }} {{ place.rank }}. {{ place.name }}
              </h4>
              <span class="text-sm text-gray-600">{{ place.city }}</span>
            </div>
            
            <div class="grid grid-cols-3 gap-4 text-sm">
              <div class="text-center">
                <p class="text-gray-600">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                <p class="font-bold text-blue-600">{{ place.average }}</p>
              </div>
              <div class="text-center">
                <p class="text-gray-600">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</p>
                <p class="font-bold text-green-600">{{ place.minimum }}</p>
              </div>
              <div class="text-center">
                <p class="text-gray-600">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</p>
                <p class="font-bold text-red-600">{{ place.maximum }}</p>
              </div>
            </div>
            
            <div class="mt-2 text-xs text-gray-500">
              ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {{ place.data_points }} ‡∏à‡∏∏‡∏î
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Other Categories -->
    {# "‡∏ß‡∏±‡∏î/‡∏®‡∏≤‡∏™‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô" is now part of tourism, so removed from here #}
    {% for category, places in {
      "‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°": results.hotels,
      "‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£": results.restaurants,
      "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤": results.shopping
    }.items() %}
    
    {% if places %}
    <div class="mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
        {% if category == "‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°" %}üè®{% endif %}
        {% if category == "‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£" %}üçΩÔ∏è{% endif %}
        {% if category == "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤" %}üõçÔ∏è{% endif %}
        {{ category }}
        <span class="ml-2 bg-gray-100 text-gray-800 text-sm px-2 py-1 rounded-full">{{ places|length }}</span>
      </h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {# --- Custom ranking logic for medals --- #}
        {% set last_value = None %}
        {% set rank = 0 %}
        {% set shown = 0 %}
        {% for place in places %}
        <div class="bg-white rounded-lg shadow-md card-hover p-4">
          <h4 class="font-semibold text-gray-800 mb-2">{{ place.name }}</h4>
          
          {% if place.air_quality %}
          <div class="mb-3 flex flex-wrap gap-2">
            {% set aqi = place.air_quality.aqi %}
            {% set pm25 = place.air_quality.pm25 %}
            {% set pm10 = place.air_quality.pm10 %}
            {% set aqi_level_class = 'air-quality-good' %}
            {% set aqi_level_icon = 'üü¢' %}
            {% if aqi > 200 %}
              {% set aqi_level_class = 'air-quality-hazardous' %}
              {% set aqi_level_icon = '‚ö´' %}
            {% elif aqi > 150 %}
              {% set aqi_level_class = 'air-quality-unhealthy' %}
              {% set aqi_level_icon = 'üî¥' %}
            {% elif aqi > 100 %}
              {% set aqi_level_class = 'air-quality-unhealthy-sensitive' %}
              {% set aqi_level_icon = 'üü†' %}
            {% elif aqi > 50 %}
              {% set aqi_level_class = 'air-quality-moderate' %}
              {% set aqi_level_icon = 'üü°' %}
            {% endif %}
            {# --- Custom medal logic --- #}
            {% set value = aqi %}
            {% if sort_by_dust == 'pm25' %}
              {% set value = pm25 %}
            {% elif sort_by_dust == 'pm10' %}
              {% set value = pm10 %}
            {% endif %}
            {% if value != last_value and value is not none %}
              {% set rank = rank + 1 %}
              {% set last_value = value %}
            {% endif %}
            {% set rank_icon = '' %}
            {% if rank == 1 %}
              {% set rank_icon = 'ü•á' %}
            {% elif rank == 2 %}
              {% set rank_icon = 'ü•à' %}
            {% elif rank == 3 %}
              {% set rank_icon = 'ü•â' %}
            {% endif %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium {{ aqi_level_class }}">
              {% if sort_by_dust == 'aqius' %}
                {{ aqi_level_icon }} AQI: {{ aqi }}
              {% elif sort_by_dust == 'pm25' %}
                {{ aqi_level_icon }} PM2.5: {{ pm25 }}
              {% elif sort_by_dust == 'pm10' %}
                {{ aqi_level_icon }} PM10: {{ pm10 }}
              {% endif %}
              {% if rank <= 3 and rank_icon %}<span class="ml-1">{{ rank_icon }}</span>{% endif %}
            </span>
            {% if pm25 %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              PM2.5: {{ pm25 }}
              {% if sort_by_dust == 'pm25' and rank <= 3 and rank_icon %}<span class="ml-1">{{ rank_icon }}</span>{% endif %}
            </span>
            {% endif %}
            {% if pm10 %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
              PM10: {{ pm10 }}
              {% if sort_by_dust == 'pm10' and rank <= 3 and rank_icon %}<span class="ml-1">{{ rank_icon }}</span>{% endif %}
            </span>
            {% endif %}
          </div>
          {% endif %}
          
          <div class="space-y-1 text-sm text-gray-600">
            <p class="flex items-start">
              <span class="font-medium text-gray-800 mr-1">üìç</span>
              <span class="line-clamp-2">{{ place.full_address }}</span>
            </p>
            
            {% if place.type %}
            <p class="flex items-center">
              <span class="font-medium text-gray-800 mr-1">üè∑Ô∏è</span>
              <span>{{ place.type }}</span>
            </p>
            {% endif %}
          </div>
          
          <div class="mt-3">
            <a 
              href="https://maps.google.com/?q={{ place.lat }},{{ place.lon }}" 
              target="_blank" 
              class="inline-flex items-center px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors"
            >
              üó∫Ô∏è ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    {% endfor %}

    <!-- No Results Message -->
    {% if province and not results.tourism and not results.hotels and not results.restaurants and not results.shopping %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
      <div class="text-yellow-600 text-6xl mb-4">üîç</div>
      <h3 class="text-xl font-semibold text-yellow-800 mb-2">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
      <p class="text-yellow-700">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î "{{ province }}"</p>
      <p class="text-yellow-600 text-sm mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏Å‡∏î‡∏Ñ‡∏≥</p>
    </div>
    {% endif %}

    {% endif %}

    <!-- Popular Provinces -->
    {% if not province %}
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">üåü ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        {% for prov in ["‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô"] %}
        <button 
          onclick="document.getElementById('province').value='{{ prov }}'; document.querySelector('form').submit();"
          class="bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium py-2 px-4 rounded-lg transition-colors text-sm"
        >
          {{ prov }}
        </button>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>

  <!-- Air Quality Modal -->
  <div id="airQualityModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">üå¨Ô∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</h3>
        <button onclick="closeAirQualityModal()" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div id="airQualityContent">
        <!-- Content will be inserted here -->
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-6 mt-12">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <p>&copy; 2024 Thailand Tourism App | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å OpenStreetMap & AirVisual</p>
    </div>
  </footer>

  <script>
    function toggleTimeSeriesOptions() {
      const checkbox = document.getElementById('enable_time_series');
      const options = document.getElementById('timeSeriesOptions');
      
      if (checkbox.checked) {
        options.classList.remove('hidden');
        // Set default dates if not already set
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        
        if (!document.getElementById('start_date').value) {
          document.getElementById('start_date').value = weekAgo;
        }
        if (!document.getElementById('end_date').value) {
          document.getElementById('end_date').value = today;
        }
      } else {
        options.classList.add('hidden');
      }
    }
    
    function toggleTimeMode() {
      const timeMode = document.getElementById('time_mode').value;
      const historicalOptions = document.getElementById('historicalOptions');
      const forecastOptions = document.getElementById('forecastOptions');
      
      if (timeMode === 'forecast') {
        historicalOptions.classList.add('hidden');
        forecastOptions.classList.remove('hidden');
      } else {
        historicalOptions.classList.remove('hidden');
        forecastOptions.classList.add('hidden');
        
        if (timeMode === 'historical') {
          // Set default historical dates
          const today = new Date().toISOString().split('T')[0];
          const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
          
          document.getElementById('start_date').value = weekAgo;
          document.getElementById('end_date').value = today;
        }
      }
    }
    
    function showAirQualityDetails(city, aqi, description, pm25, pm10) {
      let aqiLevelClass = 'air-quality-good';
      let aqiLevelIcon = 'üü¢';
      
      if (aqi > 200) {
        aqiLevelClass = 'air-quality-hazardous';
        aqiLevelIcon = '‚ö´';
      } else if (aqi > 150) {
        aqiLevelClass = 'air-quality-unhealthy';
        aqiLevelIcon = 'üî¥';
      } else if (aqi > 100) {
        aqiLevelClass = 'air-quality-unhealthy-sensitive';
        aqiLevelIcon = 'üü†';
      } else if (aqi > 50) {
        aqiLevelClass = 'air-quality-moderate';
        aqiLevelIcon = 'üü°';
      }
      
      const content = `
        <div class="space-y-4">
          <div class="text-center">
            <div class="text-4xl mb-2">${aqiLevelIcon}</div>
            <div class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium ${aqiLevelClass}">
              AQI: ${aqi}
            </div>
          </div>
          
          <div class="space-y-2">
            <p><strong>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${city}</p>
            <p><strong>üìä ‡∏Ñ‡πà‡∏≤ AQI (US):</strong> ${aqi}</p>
            ${pm25 ? `<p><strong>üí® PM2.5:</strong> ${pm25}</p>` : ''}
            ${pm10 ? `<p><strong>üí® PM10:</strong> ${pm10}</p>` : ''}
            <p><strong>‚ÑπÔ∏è ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong> ${description}</p>
          </div>
          
          <div class="bg-gray-50 p-3 rounded-lg text-sm">
            <p class="font-medium mb-1">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</p>
            <p class="text-gray-700">${getHealthAdvice(aqi)}</p>
          </div>
        </div>
      `;
      
      document.getElementById('airQualityContent').innerHTML = content;
      document.getElementById('airQualityModal').classList.remove('hidden');
      document.getElementById('airQualityModal').classList.add('flex');
    }
    
    function closeAirQualityModal() {
      document.getElementById('airQualityModal').classList.add('hidden');
      document.getElementById('airQualityModal').classList.remove('flex');
    }
    
    function getHealthAdvice(aqi) {
      if (aqi <= 50) return '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó';
      if (aqi <= 100) return '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ‡∏Ñ‡∏ô‡πÑ‡∏ß‡∏ï‡πà‡∏≠‡∏°‡∏•‡∏û‡∏¥‡∏©‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢';
      if (aqi <= 150) return '‡πÑ‡∏°‡πà‡∏î‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡∏Ñ‡∏ô‡πÑ‡∏ß‡∏ï‡πà‡∏≠‡∏°‡∏•‡∏û‡∏¥‡∏©‡∏Ñ‡∏ß‡∏£‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏Å';
      if (aqi <= 200) return '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÑ‡∏°‡πà‡∏î‡∏µ ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Ñ‡∏ß‡∏£‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á';
      return '‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏¢‡πà‡∏°‡∏≤‡∏Å ‡∏Ñ‡∏ß‡∏£‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
    }
    
    // Close modal when clicking outside
    document.getElementById('airQualityModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeAirQualityModal();
      }
    });
    
    // Auto-focus on search input
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('province').focus();
      
      // Add event listeners for air quality buttons
      document.querySelectorAll('.air-quality-btn').forEach(button => {
        button.addEventListener('click', function() {
          const city = this.dataset.city || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          const aqi = parseInt(this.dataset.aqi) || 0;
          const description = this.dataset.description || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
          const pm25 = parseInt(this.dataset.pm25) || 0;
          const pm10 = parseInt(this.dataset.pm10) || 0;
          
          showAirQualityDetails(city, aqi, description, pm25, pm10);
        });
      });
    });
  </script>

</body>
</html>
